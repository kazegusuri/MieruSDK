/**********************************************************************
 * SimMips: Simple Computer Simulator of MIPS    Arch Lab. TOKYO TECH *
 **********************************************************************/
COPYRIGHT

SimMips is free software.
See the file COPYING for copying permission.

/**********************************************************************/
/* 0. Index                                                           */
/**********************************************************************/
 1. About SimMips
 2. Building your SimMips binary  
 3. Let's run SimMips  
 4. Various modes of SimMips
 5. Command Line Options
 6. Machine Setting File
 7. SimMips History
 8. Project
 9. Reference

/**********************************************************************/
/* 1. About SimMips                                                   */
/**********************************************************************/
計算機アーキテクチャやオペレーティングシステムの教育・研究ツールとして，
システムシミュレータへの要求が高まっています．しかしながら，既存のシス
テムシミュレータは，数多くのプラットフォームに対応することや，高速に動
作することに主眼をおいているため，教育・研究において重要となるシンプル
さや可読性を失っています．

こうした既存のシミュレータとは一線を画し，シンプルさや可読性，拡張性を
重視した，MIPS32命令セットのプロセッサを含むシステムシミュレータである
SimMips の開発をおこなっています．可読性と実行速度との間にはトレードオ
フがありますが，プロセッサの高速化により，高い可読性と現実的な実行速度
との両立が可能となりつつあります．SimMips は，計算機システムやOSの教育・
研究・開発に大いに利点を発揮します．

/**********************************************************************/
/* 2. Building your SimMips binary                                    */
/**********************************************************************/
SimMipsはクリーンなC++で記述されています．Intel Linux, Intel Cygwinな
どの環境で動作を確認しています．（ただし，一部モードではXに対応してい
る必要があります）
現時点ではBig-Endianのプラットフォーム，例えばCell/B.E. Linux などの環
境では動作しません．

SimMips の実行ファイルを作成するためにはコンパイルが必要です．
SimMips の配布パッケージをダウンロードして，展開します．
（このファイルを読んでいるということは，既にパッケージが展開されている
　かもしれませんが．）

例えば，ファイル名がSimMips-0.6.6.tgz ならば，以下のコマンドでパッケー
ジを展開します．

$ tar xvzf SimMips-0.6.6.tgz

SimMips-0.6.6 というディレクトリが作成され，その中にソースコードなど
が展開されます．次に，展開されたディレクトリに移動してコンパイルします．

$ cd SimMips-0.6.6
$ make

コンパイルが正常に終了すれば，binディレクトリの中に SimMips ほかいくつ
かの実行ファイルが出来ているはずです．

$ ls bin/
SimMieru  SimMips  SimMipsF  SimMipsM  SimMipsOS

/**********************************************************************/
/* 3. Let's run SimMips                                               */
/**********************************************************************/
パラメータを指定せずにSimMips を実行すると，簡単な使い方が表示されます．

| $ ./bin/SimMips
| ## SimMips: Simple Computer Simulator of MIPS Version 0.6.6 2010-07-02
| Usage: SimMips [-options] object_file_name
|  [Basic Options]
|   -e[num][kmg]: stop simulation after num cycles executed
|   -k[num][kmg]: skip first num cycles
|   -d1: debug mode 1: put the architectural state after simulation
|   -d2: debug mode 2: put all the instructions executed
|   -d3: debug mode 3: put the trace of the execution
|   -i: put the instruction mix after simulation
|   -M [filename]: specify machine setting file

サンプルとして，クイックソートのプログラムがtest/qsortに置かれています．
まずは，このプログラムをSimMips で動作させてみましょう．

| $ ./bin/SimMips test/qsort
| ## SimMips: Simple Computer Simulator of MIPS Version 0.6.6 2010-07-02
|
| Before:   65536 items quick sorting.
| a[    0] =        9086
| a[  200] =       28147
| a[  400] =        7617
| a[  600] =        9586
| a[  800] =       18764
| a[ 1000] =       28363
| a[ 1200] =       23597
| a[ 1400] =       26600
| a[ 1600] =        6196
| a[ 1800] =       12923
| 
| After:   65536 items quick sorting.
| a[    0] =           0
| a[  200] =          98
| a[  400] =         197
| a[  600] =         300
| a[  800] =         402
| a[ 1000] =         503
| a[ 1200] =         600
| a[ 1400] =         701
| a[ 1600] =         802
| a[ 1800] =         897
| 
| ## cpu stopped
| ## cycle count: 17663749
| ## inst count: 17663749
| ## simulation time:    1.431
| ## mips: 12.343

上のようなメッセージが表示されましたか？
実行時間など(一番下の2行) は，利用している計算機によって変化します．

/**********************************************************************/
/* 4. Various modes of SimMips                                        */
/**********************************************************************/
各モードの()内は(simを起点としたソースコードのディレクトリ/生成される
バイナリ名)を表しています．

- Appモード (core/SimMips)
静的にリンクされたMIPSアプリケーションを実行するためのモードです．また，
他のモードを構成するための基礎となる部分が実装されています．

- MultiCycleモード (multicycle/SimMipsM)
Appモードと実行できるアプリケーションは同一ですが，1命令を複数サイクル
かけて実行するマルチサイクルの実行モデルを取ります．v0.5.x以前における
-mオプションに相当するものです．

- OSモード (osmode/SimMipsOS)
OSカーネルとディスクイメージを指定して，LinuxなどのOSを動作させるモー
ドです．MIPSプロセッサ制御(CP0)と割込みコントローラ，シリアルコントロ
ーラなどの動作のシミュレートが含まれます．以下のURLからダウンロードで
きるmipsel用ディスクイメージを解凍したものをimageディレクトリに置き，
mem_qemu.txtをマシンセッティングファイルに，vmlinux-2.6.18-3-qemuを実
行バイナリとして実行することで，動作を確認することができます．
　http://wiki.qemu.org/Download

- Floatモード (float/SimMipsF)
AppモードにFPUが追加された，浮動小数点を扱うアプリケーションを実行する
ためのモードです．

- MieruPCモード (mieru/SimMieru)
MieruPC-2008，および2010で実行可能なアプリケーション，あるいはOSを実行
するためのモードです．液晶ディスプレイのシミュレーションにはMieruSDK※
に同梱の液晶シミュレータを利用します．液晶シミュレータを動作させるため
にはXが必要です．このモードは，v0.5.x以前でAppモードの一部として提供さ
れていたものを拡張したものです．

※ MieruSDKは，MieruPCプロジェクトのWebサイトにて公開予定です．
　http://www.arch.cs.titech.ac.jp/mieru/

/**********************************************************************/
/* 5. Command Line Options                                            */
/**********************************************************************/
-eオプションは，一定サイクルの実行が完了するとシミュレーションを終了す
るオプションです．接尾辞として，k またはK(1,000)，m またはM(100万)，
g またはG(10億) が利用できます．

| $ ./SimMips -e10k test/qsort
| ## SimMips: Simple Computer Simulator of MIPS Version 0.5.0 2008-11-05
| 
| ## cycle count reaches the limit
| ## cycle count: 10000
| ## inst count: 10000
| ## simulation time:    0.001
| ## mips: 11.455

-kオプションは，一定サイクルの実行が完了するまでの間出力を抑制するオプ
ションです．抑制される出力にはデバッグモードの出力を含みます．

-dオプションは，デバッグモードです．1〜4までのモードを指定します．
-d1 は，シミュレーション終了時にレジスタ値とメモリの内容を表示します．
-d2 は，実行された命令列を表示します．
-d3 は，実行された命令列と読み書きされたレジスタの値を表示します．
-d4 は，発生した例外とTLB の読み書き履歴を表示します(OSモードのみ)．

-iオプションは，シミュレーション終了時に実行された命令の種類と回数を表
示します．使用された回数が多い順に並べ替えられます．

-Mオプションは，メモリやレジスタの初期設定用のファイルを指定します．
詳細仕様は後述します．

-lオプションは，MieruPCモードで使用します．液晶シミュレータのパイプの
パスを指定します．

-tオプションは，MieruPCモードで使用します．アプリケーション(やOS)が想
定する液晶ユニットの種類を指定します．-t0でMieruPC-2008の液晶ユニット，
-t1でMieruPC-2010の液晶ユニットを想定します．

/**********************************************************************/
/* 6. Machine Setting File                                            */
/**********************************************************************/
マシンセッティングファイルは-Mオプションで指定します．下記のフォーマッ
トに従って記述されたテキストファイルを読み込ませることで，レジスタ値や
メモリマップ，メモリの初期値などを指定することが出来ます．

ヘッダ(1行目)は「SimMips_Machine_Setting」で固定です．
2行目以降は，@で始まる行をコマンドとして扱い，それ以外はコメントです．

★@reg $REG=VALUE レジスタ値の指定
例) @reg $a0=0x12345678
レジスタ名は$4のような数字でも，$a0のような(小文字)別名でも構いません．
PCは$pc，または$32と指定します．

★@map BASE SIZE NAME 物理メモリマップの指定
例) @map 0x0 0x1000000 MAIN_MEMORY
アドレスが重複する場合は先に書いた物が優先されます．

NAMEで指定可能な名前は以下の通りです．
名前        対象モード　 概要
MAIN_MEMORY すべて       メインメモリ
ISA_IO      OS           ISAバスのIO(現在は割り込みとシリアル入出力)
ISA_BUS     OS           ISAバス(現在は空の実装)
MIERU_IO    MieruPC      MieruPCのIO
MMC_IO      MieruPC      マルチメディアカードのバス

★@mem ADDR NAME メインメモリへのファイル書き込み
例) @mem 0x00010000 hoge.bin
ADDRで指定したアドレス以降にNAMEで指定したファイルの中身を書き込みます．

★@mmc SIZE NAME マルチメディアカードの指定(MieruPCモードのみ)
例) @mmc 1m image.dat
マルチメディアカードとして，サイズSIZEのものを想定します．SIZEには接尾
辞k, m, gを指定できます．カード内の初期データは，NAMEで指定されたファ
イルから読み込みます．NAMEを指定しなかった場合は初期データはゼロで埋め
られます．また，NAMEで指定したファイルのサイズがSIZE未満の場合，残りの
部分はゼロで埋められます．

/**********************************************************************/
/* 7. SimMips History                                                 */
/**********************************************************************/
主要なバージョンを記載しています．

v0.6.7 2010-07-02 (3,110 + 4,427 lines)
・MieruPCモードでMMCイメージのファイル名関連にバグがあったのを修正．

v0.6.6 2010-07-02 (3,110 + 4,409 lines)
・一部の浮動小数点命令が正しくデコードできなかった不具合を修正．

v0.6.5 2010-06-30 (3,111 + 4,409 lines)
・マシンセッティングファイルに記述するパスの指定方法を，現在の作業ディ
　レクトリではなく，ファイル自身からの相対パスとした．

v0.6.4 2010-06-17 (3,084 + 4,409 lines)
・命令トレース機能（-d2または-d3）に関数シンボルの表示を追加．

v0.6.3 2010-06-14 (3,051 + 4,409 lines)
・mieruにMieruPC2008向けのアプリケーションへの対応を追加．
（-t0オプションをつけて実行してください）

v0.6.2 2010-06-11 (3,051 + 4,233 lines)
・MieruPCに対応する付加機能(mieru)を追加．
（現在はMieruPC2010向け液晶のみ対応）

v0.6.1 2010-06-10 (3,022 + 3,164 lines)
・浮動小数点命令に対応する付加機能(float)を追加．

v0.6.0 2010-06-02 (3,026 + 1,563 lines)
・内部構造を大幅に刷新．
　基本機能(App，機能レベル)をcore，付加機能をその拡張とする方法に．
　マルチサイクルはmulticycle，OSモードはosmodeにまとめている．
　MieruPC向けの拡張はまだ未実装．

v0.5.5 2009-05-13 (4,540 lines)
・MieruPC-2008への対応，およびバグフィックス．

v0.5.0 2008-11-05 (4,422 lines)
・MieruPC 向けに別で開発していたバージョンを統合．v0.5.0として公開．

v0.4.9 2008-08-13 (4,090 lines)
・ソースコードの見直しや，機能の追加などを随時行ってきた．

v0.4.0 2008-06-17 (3,765 lines)
・OSモードのバグ取りが終わる．シェルが立ち上がり，lsなどの動作を確認．

v0.3.1 2008-06-04 (3,459 lines)
・割り込みコントローラとシリアルインタフェースを実装．
　詳細な検証はしていない．

v0.3.0 2008-05-27 (2,980 lines)
・Coprocessor 0(CP0)を実装．詳細な検証はしていない．

v0.2.0 2008-04-14 (2,384 lines)
・App モードの実装終了．nqueenプログラムが動作．

/**********************************************************************/
/* 8. Project                                                         */
/**********************************************************************/
SimMips の開発は，MieruPC プロジェクト（中身が見える計算機システムを構
築する研究・教育プロジェクト）の一環としても行われています．
MieruPC プロジェクトに関する情報は以下のURLに掲載されています．
　http://www.arch.cs.titech.ac.jp/mieru/
MieruPCのハードウェアに関しては以下のURLに掲載されています．
　http://www.mierupc.com/

また，SimMipsの開発の一部は，独立行政法人科学技術振興機構(JST) 戦略的
創造研究推進事業(CREST)の支援を受けています．

/**********************************************************************/
/* 9. Reference                                                       */
/**********************************************************************/
[1] 藤枝直輝, 渡邉伸平, 吉瀬謙二： 教育・研究に有用なMIPSシステムシミ
ュレータSimMips, 情報処理学会論文誌, Vol.50, No.11, pp. 2665-2676. 
(November 2009)

[2] Naoki Fujieda, Takefumi Miyoshi, and Kenji Kise: SimMips: A MIPS 
System Simulator, Workshop on Computer Architecture Education(WCAE)
held in conjunction with MICRO-42, pp. 32-39. (December 2009)

[3] 藤枝直輝, 渡邉伸平, 吉瀬謙二: SimMips: 教育・研究に有用なLinuxが動
く5000行のMIPSシステムシミュレータ, 第20回コンピュータシステム・シンポ
ジウム(ComSys2008), pp. 143-150 (November 2008).

[4] 吉瀬謙二, 佐藤真平, 森谷章, 藤枝直輝, 若杉祐太, 渡邉伸平, 植原昂,
森洋介, 高前田伸也, 高橋朝英, 棟岡朋也, 山田裕介, 権藤克彦, 小林良太郎,
三好健文, 中條拓伯: MieruPC プロジェクト: 中身が見える計算機システムを
構築する研究・教育プロジェクト, 第20回コンピュータシステム・シンポジウ
ム(ComSys2008) (November 2008).

[5] 渡邉伸平, 藤枝直輝, 若杉祐太, 高前田伸也, 森洋介, 吉瀬謙二: MIPSシ
ステムシミュレータSimMips を活用した組込みシステム開発の検討,　情報処
理学会研究報告 2008-EMB-10 (November 2008).

/**********************************************************************/